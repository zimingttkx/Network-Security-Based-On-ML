# 网络安全威胁检测系统 - 项目架构文档

## 目录
- [项目概述](#项目概述)
- [目录结构](#目录结构)
- [系统架构图](#系统架构图)
- [核心模块详解](#核心模块详解)
- [数据流程图](#数据流程图)
- [训练管道流程](#训练管道流程)
- [预测流程](#预测流程)
- [高级检测模块](#高级检测模块)

---

## 项目概述

本项目是一个基于机器学习和深度学习的网络安全威胁检测系统，能够识别钓鱼网站和恶意URL。系统采用模块化设计，支持多种检测方法的集成。

### 核心功能
- **URL特征提取**: 自动从URL提取30个安全特征
- **机器学习检测**: 支持8种ML算法自动选优
- **深度学习检测**: 支持DNN/CNN/LSTM模型
- **NLP文本分析**: 基于BERT的网页内容分类
- **视觉相似度检测**: 基于CNN的截图比对
- **集成检测**: 多模型加权融合决策

---

## 目录结构

```
Network-Security-Based-On-ML/
│
├── app.py                      # 主应用入口 (FastAPI Web服务)
├── requirements.txt            # Python依赖包
├── setup.py                    # 项目安装配置
├── README.md                   # 项目说明
├── ARCHITECTURE.md             # 本文档
│
├── networksecurity/            # 核心代码包
│   ├── __init__.py
│   │
│   ├── api/                    # API层
│   │   ├── __init__.py
│   │   └── app.py              # 企业级API (版本化、限流、监控)
│   │
│   ├── components/             # 核心组件层
│   │   ├── __init__.py
│   │   ├── data_ingestion.py       # 数据摄取组件
│   │   ├── data_validation.py      # 数据验证组件
│   │   ├── data_transformation.py  # 数据转换组件
│   │   ├── model_trainer.py        # ML模型训练器
│   │   ├── dl_model_trainer.py     # DL模型训练器
│   │   ├── bert_classifier.py      # BERT文本分类器
│   │   ├── visual_similarity.py    # 视觉相似度检测
│   │   └── ensemble_detector.py    # 集成检测器
│   │
│   ├── pipeline/               # 管道层
│   │   ├── __init__.py
│   │   ├── training_pipeline.py    # 训练管道
│   │   └── batch_prediction.py     # 批量预测管道
│   │
│   ├── entity/                 # 实体定义层
│   │   ├── __init__.py
│   │   ├── config_entity.py        # 配置实体类
│   │   └── artifact_entity.py      # 产物实体类
│   │
│   ├── config/                 # 配置管理层
│   │   ├── __init__.py
│   │   └── config_manager.py       # 配置管理器
│   │
│   ├── constant/               # 常量定义层
│   │   ├── __init__.py
│   │   └── training_pipeline/
│   │       └── __init__.py         # 训练管道常量
│   │
│   ├── utils/                  # 工具层
│   │   ├── __init__.py
│   │   ├── main_utils/
│   │   │   └── utils.py            # 通用工具函数
│   │   ├── ml_utils/
│   │   │   ├── data_validator.py   # 数据验证器
│   │   │   ├── model_explanation.py # SHAP模型解释
│   │   │   ├── metric/
│   │   │   │   └── classification_metric.py  # 分类指标
│   │   │   └── model/
│   │   │       ├── estimator.py    # 模型估计器
│   │   │       ├── ensemble.py     # 集成模型
│   │   │       └── automl.py       # 自动机器学习
│   │   ├── url_feature_extractor.py    # URL特征提取器
│   │   └── web_content_extractor.py    # 网页内容提取器
│   │
│   ├── exception/              # 异常处理层
│   │   ├── __init__.py
│   │   └── exception.py            # 自定义异常
│   │
│   ├── logging/                # 日志层
│   │   ├── __init__.py
│   │   └── logger.py               # 日志配置
│   │
│   └── cloud/                  # 云服务层
│       └── __init__.py             # 云存储接口
│
├── templates/                  # HTML模板
│   ├── index.html                  # 首页
│   ├── predict.html                # 预测页面
│   ├── training.html               # 训练控制台
│   ├── evaluation.html             # 评估报告
│   ├── explanation.html            # 模型解释
│   ├── pipeline.html               # 管道浏览器
│   └── tutorial.html               # 使用教程
│
├── static/                     # 静态资源
│   ├── css/                        # 样式文件
│   └── js/                         # JavaScript文件
│
├── config/                     # 配置文件
│   └── config.yaml                 # 主配置文件
│
├── data_schema/                # 数据模式
│   └── schema.yaml                 # 数据字段定义
│
├── data/                       # 训练数据
│   └── phisingData.csv             # 钓鱼数据集
│
├── models/                     # 训练好的模型
│   ├── model.pkl                   # 最佳模型
│   └── preprocessor.pkl            # 预处理器
│
├── artifacts/                  # 训练产物
│   └── {timestamp}/                # 按时间戳组织
│       ├── data_ingestion/
│       ├── data_validation/
│       ├── data_transformation/
│       └── model_trainer/
│
├── logs/                       # 日志文件
│   └── *.log
│
├── tests/                      # 测试文件
│   ├── __init__.py
│   ├── conftest.py                 # pytest配置
│   ├── test_config.py
│   ├── test_data_ingestion.py
│   ├── test_data_validator.py
│   ├── test_model_explanation.py
│   ├── test_url_feature_extractor.py
│   ├── test_nlp_cv_modules.py
│   ├── test_api_functionality.py
│   └── test_dl_functionality.py
│
├── docs/                       # 项目文档
│   ├── Home.md
│   ├── API文档.md
│   ├── 项目架构.md
│   ├── 模型训练.md
│   ├── 威胁预测.md
│   ├── 安装指南.md
│   ├── 快速入门.md
│   └── 常见问题.md
│
└── .github/                    # GitHub配置
    ├── workflows/                  # CI/CD工作流
    ├── ISSUE_TEMPLATE/             # Issue模板
    └── PULL_REQUEST_TEMPLATE.md    # PR模板
```

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户界面层 (Frontend)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│  │  首页   │  │  预测   │  │  训练   │  │  评估   │  │  解释   │           │
│  │ index   │  │ predict │  │training │  │evaluate │  │ explain │           │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘           │
└───────┼────────────┼────────────┼────────────┼────────────┼─────────────────┘
        │            │            │            │            │
        └────────────┴────────────┴─────┬──────┴────────────┘
                                        │
┌───────────────────────────────────────┼─────────────────────────────────────┐
│                              API网关层 (app.py)                              │
├───────────────────────────────────────┼─────────────────────────────────────┤
│                                       │                                      │
│  ┌────────────────────────────────────┴────────────────────────────────┐    │
│  │                         FastAPI Application                          │    │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐  │    │
│  │  │ /predict │ │ /train   │ │/evaluate │ │/explain  │ │/api/v1/* │  │    │
│  │  │ _live    │ │          │ │          │ │          │ │          │  │    │
│  │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘  │    │
│  └───────┼────────────┼────────────┼────────────┼────────────┼────────┘    │
│          │            │            │            │            │              │
│  ┌───────┴────────────┴────────────┴────────────┴────────────┴───────┐     │
│  │                      中间件 (Middleware)                           │     │
│  │  [CORS] [GZip压缩] [请求日志] [Prometheus监控] [异常处理]          │     │
│  └───────────────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              业务逻辑层 (Business Logic)                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      训练管道 (TrainingPipeline)                     │    │
│  │  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐         │    │
│  │  │   数据   │──▶│   数据   │──▶│   数据   │──▶│   模型   │         │    │
│  │  │   摄取   │   │   验证   │   │   转换   │   │   训练   │         │    │
│  │  └──────────┘   └──────────┘   └──────────┘   └──────────┘         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      预测管道 (Prediction)                           │    │
│  │  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐         │    │
│  │  │   URL    │──▶│   特征   │──▶│   模型   │──▶│   结果   │         │    │
│  │  │   输入   │   │   提取   │   │   推理   │   │   输出   │         │    │
│  │  └──────────┘   └──────────┘   └──────────┘   └──────────┘         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      高级检测 (Advanced Detection)                   │    │
│  │  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐         │    │
│  │  │ 统计特征 │   │ BERT文本 │   │ CNN视觉  │   │   集成   │         │    │
│  │  │   检测   │   │   分析   │   │   检测   │   │   融合   │         │    │
│  │  └──────────┘   └──────────┘   └──────────┘   └──────────┘         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据访问层 (Data Access)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │   MongoDB    │  │   本地CSV    │  │   模型文件   │  │   配置文件   │    │
│  │   (可选)     │  │   data/      │  │   models/    │  │   config/    │    │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 核心模块详解

### 1. 组件层 (Components)

#### 1.1 数据摄取组件 (DataIngestion)
```
文件: networksecurity/components/data_ingestion.py

职责:
├── 从MongoDB或本地CSV读取原始数据
├── 数据去重和基础清洗
├── 划分训练集和测试集 (80:20)
└── 保存到feature_store目录

输入: MongoDB连接 或 data/phisingData.csv
输出: DataIngestionArtifact
      ├── train_file_path: 训练集路径
      └── test_file_path: 测试集路径
```

#### 1.2 数据验证组件 (DataValidation)
```
文件: networksecurity/components/data_validation.py

职责:
├── 验证数据列数是否符合schema
├── 验证数值列是否存在且类型正确
├── 使用KS检验检测数据漂移
└── 生成数据漂移报告

输入: DataIngestionArtifact
输出: DataValidationArtifact
      ├── validation_status: 验证状态
      ├── valid_train_file_path: 有效训练集
      ├── valid_test_file_path: 有效测试集
      └── drift_report_file_path: 漂移报告
```

#### 1.3 数据转换组件 (DataTransformation)
```
文件: networksecurity/components/data_transformation.py

职责:
├── 使用KNN填充缺失值
├── 特征标准化处理
├── 将数据转换为numpy数组
└── 保存预处理器对象

输入: DataValidationArtifact
输出: DataTransformationArtifact
      ├── transformed_train_file_path: 转换后训练集(.npy)
      ├── transformed_test_file_path: 转换后测试集(.npy)
      └── transformed_object_file_path: 预处理器(.pkl)
```

#### 1.4 模型训练组件 (ModelTrainer)
```
文件: networksecurity/components/model_trainer.py

职责:
├── 训练8种机器学习模型
│   ├── RandomForest
│   ├── GradientBoosting
│   ├── AdaBoost
│   ├── LogisticRegression
│   ├── SVC
│   ├── KNeighbors
│   ├── GaussianNB
│   └── XGBoost
├── GridSearchCV超参数优化
├── 选择最佳模型
└── 保存模型到models/目录

输入: DataTransformationArtifact
输出: ModelTrainerArtifact
      ├── trained_model_file_path: 模型路径
      ├── train_metric_artifact: 训练指标
      └── test_metric_artifact: 测试指标
```

#### 1.5 深度学习训练组件 (DLModelTrainer)
```
文件: networksecurity/components/dl_model_trainer.py

职责:
├── 支持三种深度学习架构
│   ├── DNN: 全连接深度神经网络
│   ├── CNN: 一维卷积神经网络
│   └── LSTM: 长短期记忆网络
├── 自定义训练配置
├── 早停和学习率调度
└── 保存Keras模型

输入: DataTransformationArtifact + 模型配置
输出: ModelTrainerArtifact + Keras模型文件
```

#### 1.6 BERT分类器 (BERTClassifier)
```
文件: networksecurity/components/bert_classifier.py

职责:
├── 加载预训练DistilBERT模型
├── 冻结底层Transformer层
├── 添加可训练分类头
├── 网页文本内容分类
└── 输出钓鱼概率分数

输入: 网页文本内容
输出: 分类概率 (0-1)
```

#### 1.7 视觉相似度检测 (VisualSimilarity)
```
文件: networksecurity/components/visual_similarity.py

职责:
├── 使用Playwright截取网页截图
├── MobileNetV2提取视觉特征
├── FAISS向量数据库存储
├── 与已知网站截图比对
└── 计算相似度分数

输入: URL
输出: 相似度分数 + 最相似网站
```

#### 1.8 集成检测器 (EnsembleDetector)
```
文件: networksecurity/components/ensemble_detector.py

职责:
├── 整合多种检测方法
│   ├── 统计特征检测 (权重: 40%)
│   ├── 文本内容检测 (权重: 35%)
│   └── 视觉相似检测 (权重: 25%)
├── 加权融合决策
└── 输出综合威胁评分

输入: URL
输出: 综合检测结果
      ├── final_score: 最终分数
      ├── prediction: 预测标签
      ├── threat_level: 威胁等级
      └── details: 各检测器详情
```

---

### 2. 管道层 (Pipeline)

#### 2.1 训练管道 (TrainingPipeline)
```
文件: networksecurity/pipeline/training_pipeline.py

职责: 编排整个训练流程

流程:
┌─────────────────────────────────────────────────────────────────┐
│                     TrainingPipeline.run_pipeline()              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────────┐                                           │
│  │ start_data_      │  读取数据源 (MongoDB/CSV)                  │
│  │ ingestion()      │  划分训练集/测试集                         │
│  └────────┬─────────┘  输出: DataIngestionArtifact              │
│           │                                                      │
│           ▼                                                      │
│  ┌──────────────────┐                                           │
│  │ start_data_      │  验证数据结构                              │
│  │ validation()     │  检测数据漂移                              │
│  └────────┬─────────┘  输出: DataValidationArtifact             │
│           │                                                      │
│           ▼                                                      │
│  ┌──────────────────┐                                           │
│  │ start_data_      │  KNN缺失值填充                             │
│  │ transformation() │  特征标准化                                │
│  └────────┬─────────┘  输出: DataTransformationArtifact         │
│           │                                                      │
│           ▼                                                      │
│  ┌──────────────────┐                                           │
│  │ start_model_     │  训练多个模型                              │
│  │ trainer()        │  选择最佳模型                              │
│  └────────┬─────────┘  输出: ModelTrainerArtifact               │
│           │                                                      │
│           ▼                                                      │
│  ┌──────────────────┐                                           │
│  │    完成训练      │  模型保存到 models/                        │
│  │                  │  产物保存到 artifacts/                     │
│  └──────────────────┘                                           │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

### 3. 实体层 (Entity)

#### 3.1 配置实体 (Config Entity)
```
文件: networksecurity/entity/config_entity.py

类结构:
┌─────────────────────────────────────────────────────────────────┐
│                    TrainingPipelineConfig                        │
│  ├── pipeline_name: str = "NetworkSecurity"                     │
│  ├── artifact_dir: str = "artifacts/{timestamp}"                │
│  └── timestamp: str                                              │
├─────────────────────────────────────────────────────────────────┤
│                    DataIngestionConfig                           │
│  ├── data_ingestion_dir: str                                    │
│  ├── feature_store_file_path: str                               │
│  ├── training_file_path: str                                    │
│  ├── testing_file_path: str                                     │
│  ├── train_test_split_ratio: float = 0.2                        │
│  ├── collection_name: str                                       │
│  └── database_name: str                                          │
├─────────────────────────────────────────────────────────────────┤
│                    DataValidationConfig                          │
│  ├── data_validation_dir: str                                   │
│  ├── valid_data_dir: str                                        │
│  ├── invalid_data_dir: str                                      │
│  ├── valid_train_file_path: str                                 │
│  ├── valid_test_file_path: str                                  │
│  └── drift_report_file_path: str                                 │
├─────────────────────────────────────────────────────────────────┤
│                    DataTransformationConfig                      │
│  ├── data_transformation_dir: str                               │
│  ├── transformed_train_file_path: str                           │
│  ├── transformed_test_file_path: str                            │
│  └── transformed_object_file_path: str                           │
├─────────────────────────────────────────────────────────────────┤
│                    ModelTrainerConfig                            │
│  ├── model_trainer_dir: str                                     │
│  ├── trained_model_file_path: str                               │
│  ├── expected_accuracy: float = 0.6                             │
│  └── overfitting_underfitting_threshold: float = 0.05            │
└─────────────────────────────────────────────────────────────────┘
```

#### 3.2 产物实体 (Artifact Entity)
```
文件: networksecurity/entity/artifact_entity.py

类结构:
┌─────────────────────────────────────────────────────────────────┐
│                    DataIngestionArtifact                         │
│  ├── train_file_path: str                                       │
│  └── test_file_path: str                                         │
├─────────────────────────────────────────────────────────────────┤
│                    DataValidationArtifact                        │
│  ├── validation_status: bool                                    │
│  ├── valid_train_file_path: str                                 │
│  ├── valid_test_file_path: str                                  │
│  ├── invalid_train_file_path: str                               │
│  ├── invalid_test_file_path: str                                │
│  └── drift_report_file_path: str                                 │
├─────────────────────────────────────────────────────────────────┤
│                    DataTransformationArtifact                    │
│  ├── transformed_object_file_path: str                          │
│  ├── transformed_train_file_path: str                           │
│  └── transformed_test_file_path: str                             │
├─────────────────────────────────────────────────────────────────┤
│                    ClassificationMetricArtifact                  │
│  ├── f1_score: float                                            │
│  ├── precision_score: float                                     │
│  └── recall_score: float                                         │
├─────────────────────────────────────────────────────────────────┤
│                    ModelTrainerArtifact                          │
│  ├── trained_model_file_path: str                               │
│  ├── train_metric_artifact: ClassificationMetricArtifact        │
│  └── test_metric_artifact: ClassificationMetricArtifact          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 数据流程图

### 完整数据流
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据流程总览                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────┐
                    │   数据源        │
                    │  MongoDB/CSV    │
                    └────────┬────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         数据摄取阶段                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  1. 连接数据源 (MongoDB优先，失败则使用本地CSV)                        │  │
│  │  2. 读取原始数据 (phisingData.csv: 11055行 x 31列)                    │  │
│  │  3. 数据清洗 (替换"na"为NaN)                                          │  │
│  │  4. 划分数据集 (train:test = 80:20)                                   │  │
│  │  5. 保存到 artifacts/{timestamp}/data_ingestion/                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  输出文件:                                                                  │
│  ├── feature_store/phisingData.csv  (完整数据)                             │
│  └── ingested/                                                              │
│      ├── train.csv  (8844行)                                               │
│      └── test.csv   (2211行)                                               │
└────────────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         数据验证阶段                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  1. 加载schema.yaml定义的数据结构                                      │  │
│  │  2. 验证列数 (期望31列)                                                │  │
│  │  3. 验证数值列存在且类型正确                                           │  │
│  │  4. KS检验检测训练集与测试集的数据漂移                                  │  │
│  │  5. 生成漂移报告 (drift_report/report.yaml)                           │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  输出文件:                                                                  │
│  ├── validated/                                                             │
│  │   ├── train.csv  (验证通过的训练集)                                     │
│  │   └── test.csv   (验证通过的测试集)                                     │
│  └── drift_report/report.yaml  (漂移检测报告)                              │
└────────────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         数据转换阶段                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  1. 分离特征和标签 (X: 30列, y: Result列)                              │  │
│  │  2. 标签编码 (-1 → 0, 1 → 1)                                          │  │
│  │  3. KNN填充缺失值 (n_neighbors=3)                                      │  │
│  │  4. 合并特征和标签为numpy数组                                          │  │
│  │  5. 保存预处理器对象 (preprocessor.pkl)                                │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  输出文件:                                                                  │
│  ├── transformed/                                                           │
│  │   ├── train.npy  (转换后训练数据)                                       │
│  │   └── test.npy   (转换后测试数据)                                       │
│  ├── transformed_object/preprocessing.pkl                                   │
│  └── models/preprocessor.pkl  (供预测API使用)                              │
└────────────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         模型训练阶段                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  机器学习模式:                                                         │  │
│  │  1. 训练8种模型 (RF, GB, AdaBoost, LR, SVC, KNN, NB, XGBoost)         │  │
│  │  2. GridSearchCV超参数优化 (cv=3)                                      │  │
│  │  3. 选择最佳模型 (基于交叉验证分数)                                    │  │
│  │  4. 计算分类指标 (F1, Precision, Recall)                              │  │
│  │  5. 保存最佳模型                                                       │  │
│  │                                                                        │  │
│  │  深度学习模式:                                                         │  │
│  │  1. 构建神经网络 (DNN/CNN/LSTM)                                        │  │
│  │  2. 配置优化器和损失函数                                               │  │
│  │  3. 训练模型 (早停+学习率调度)                                         │  │
│  │  4. 保存Keras模型                                                      │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  输出文件:                                                                  │
│  ├── model_trainer/model.pkl  (本次训练的模型)                             │
│  └── models/model.pkl  (供预测API使用的最佳模型)                           │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 预测流程

### 基础预测流程 (30特征输入)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           基础预测流程                                       │
└─────────────────────────────────────────────────────────────────────────────┘

用户输入: 30个网络流量特征值
         │
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  POST /predict_live                                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  请求体 (PredictionInput):                                            │  │
│  │  {                                                                    │  │
│  │    "having_IP_Address": 1,                                           │  │
│  │    "URL_Length": 0,                                                  │  │
│  │    "Shortining_Service": 1,                                          │  │
│  │    ... (共30个特征)                                                   │  │
│  │  }                                                                    │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  1. 加载模型和预处理器                                                      │
│     ├── models/model.pkl                                                   │
│     └── models/preprocessor.pkl                                            │
└────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  2. 数据预处理                                                              │
│     ├── 转换为DataFrame                                                    │
│     └── preprocessor.transform(input_df)                                   │
└────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  3. 模型推理                                                                │
│     └── model.predict(transformed_df)                                      │
└────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  4. 返回结果                                                                │
│     {                                                                       │
│       "prediction": "危险 (Malicious)" | "安全 (Benign)",                  │
│       "raw_prediction": 1 | 0                                              │
│     }                                                                       │
└────────────────────────────────────────────────────────────────────────────┘
```

### URL端到端预测流程
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         URL端到端预测流程                                    │
└─────────────────────────────────────────────────────────────────────────────┘

用户输入: URL字符串 (如 "https://example.com")
         │
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  POST /api/v1/predict/url                                                   │
│  请求体: { "url": "https://example.com" }                                  │
└────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                      URLFeatureExtractor                                    │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │  自动提取30个特征:                                                     │  │
│  │                                                                        │  │
│  │  URL结构特征 (10个):                                                   │  │
│  │  ├── having_IP_Address    - URL中是否包含IP地址                       │  │
│  │  ├── URL_Length           - URL长度分类                               │  │
│  │  ├── Shortining_Service   - 是否使用短链服务                          │  │
│  │  ├── having_At_Symbol     - 是否包含@符号                             │  │
│  │  ├── double_slash_redirecting - 双斜杠重定向                          │  │
│  │  ├── Prefix_Suffix        - 域名中是否有连字符                        │  │
│  │  ├── having_Sub_Domain    - 子域名数量                                │  │
│  │  ├── SSLfinal_State       - SSL证书状态                               │  │
│  │  ├── Domain_registeration_length - 域名注册时长                       │  │
│  │  └── HTTPS_token          - HTTPS令牌位置                             │  │
│  │                                                                        │  │
│  │  DNS/WHOIS特征 (5个):                                                  │  │
│  │  ├── DNSRecord            - DNS记录存在性                             │  │
│  │  ├── age_of_domain        - 域名年龄                                  │  │
│  │  ├── Favicon              - 网站图标来源                              │  │
│  │  ├── port                 - 端口号                                    │  │
│  │  └── web_traffic          - 网站流量估计                              │  │
│  │                                                                        │  │
│  │  HTML内容特征 (10个):                                                  │  │
│  │  ├── Request_URL          - 外部资源请求比例                          │  │
│  │  ├── URL_of_Anchor        - 锚点URL比例                               │  │
│  │  ├── Links_in_tags        - 标签中链接比例                            │  │
│  │  ├── SFH                  - 表单处理地址                              │  │
│  │  ├── Submitting_to_email  - 表单提交到邮箱                            │  │
│  │  ├── Abnormal_URL         - 异常URL                                   │  │
│  │  ├── Redirect             - 重定向次数                                │  │
│  │  ├── on_mouseover         - 鼠标悬停事件                              │  │
│  │  ├── RightClick           - 右键禁用                                  │  │
│  │  └── popUpWidnow          - 弹窗                                      │  │
│  │                                                                        │  │
│  │  其他特征 (5个):                                                       │  │
│  │  ├── Iframe               - 内嵌框架                                  │  │
│  │  ├── Page_Rank            - 页面排名                                  │  │
│  │  ├── Google_Index         - 谷歌索引                                  │  │
│  │  ├── Links_pointing_to_page - 外部链接数                              │  │
│  │  └── Statistical_report   - 统计报告                                  │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  模型预测 (同基础流程)                                                      │
└────────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────────────────────────┐
│  返回结果:                                                                  │
│  {                                                                          │
│    "url": "https://example.com",                                           │
│    "prediction": 0,                                                         │
│    "probability": 0.15,                                                     │
│    "threat_level": "安全",                                                  │
│    "features": { ... 30个特征值 ... },                                     │
│    "feature_extraction_time": 2.35                                         │
│  }                                                                          │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 高级检测模块

### 集成检测架构
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         高级集成检测架构                                     │
└─────────────────────────────────────────────────────────────────────────────┘

                              输入: URL
                                 │
           ┌─────────────────────┼─────────────────────┐
           │                     │                     │
           ▼                     ▼                     ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│   统计特征检测   │  │   文本内容检测   │  │   视觉相似检测   │
│   (权重: 40%)    │  │   (权重: 35%)    │  │   (权重: 25%)    │
├──────────────────┤  ├──────────────────┤  ├──────────────────┤
│                  │  │                  │  │                  │
│ URLFeatureExtractor│ │ WebContentExtractor│ │ VisualSimilarity │
│        +         │  │        +         │  │        +         │
│   XGBoost模型    │  │  BERT分类器      │  │  MobileNetV2     │
│                  │  │                  │  │  + FAISS         │
└────────┬─────────┘  └────────┬─────────┘  └────────┬─────────┘
         │                     │                     │
         │ score_1             │ score_2             │ score_3
         │ (0.0-1.0)           │ (0.0-1.0)           │ (0.0-1.0)
         │                     │                     │
         └─────────────────────┼─────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        EnsembleDetector                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  加权融合公式:                                                         │  │
│  │                                                                        │  │
│  │  final_score = 0.40 × score_1 + 0.35 × score_2 + 0.25 × score_3       │  │
│  │                                                                        │  │
│  │  威胁等级判定:                                                         │  │
│  │  ├── final_score < 0.3  → "安全" (Safe)                               │  │
│  │  ├── final_score < 0.5  → "可疑" (Suspicious)                         │  │
│  │  ├── final_score < 0.7  → "危险" (Dangerous)                          │  │
│  │  └── final_score >= 0.7 → "高危" (Critical)                           │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  输出结果:                                                                   │
│  {                                                                           │
│    "url": "https://suspicious-site.com",                                    │
│    "final_score": 0.72,                                                      │
│    "prediction": 1,                                                          │
│    "threat_level": "高危",                                                   │
│    "details": {                                                              │
│      "statistical": { "score": 0.85, "weight": 0.40 },                      │
│      "text": { "score": 0.65, "weight": 0.35 },                             │
│      "visual": { "score": 0.58, "weight": 0.25, "similar_to": "paypal.com" }│
│    }                                                                         │
│  }                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

### BERT文本分类器详解
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BERT文本分类器架构                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                         输入: 网页HTML内容
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      WebContentExtractor                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  1. 解析HTML (BeautifulSoup)                                          │  │
│  │  2. 提取<body>文本内容                                                 │  │
│  │  3. 提取表单信息 (action, method, inputs)                             │  │
│  │  4. 提取所有链接 (href)                                               │  │
│  │  5. 清洗文本 (去除脚本、样式、空白)                                    │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      BERTPhishingClassifier                                  │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  模型架构:                                                             │  │
│  │                                                                        │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │              DistilBERT (预训练)                                 │  │  │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │  │  │
│  │  │  │  Embedding Layer (30522 vocab × 768 dim)                │   │  │  │
│  │  │  └─────────────────────────────────────────────────────────┘   │  │  │
│  │  │                          │                                      │  │  │
│  │  │                          ▼                                      │  │  │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │  │  │
│  │  │  │  Transformer Layers × 6 (冻结前4层)                      │   │  │  │
│  │  │  │  - Multi-Head Attention (12 heads)                      │   │  │  │
│  │  │  │  - Feed Forward Network                                 │   │  │  │
│  │  │  │  - Layer Normalization                                  │   │  │  │
│  │  │  └─────────────────────────────────────────────────────────┘   │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                          │                                             │  │
│  │                          ▼ [CLS] token (768 dim)                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │              分类头 (可训练)                                     │  │  │
│  │  │  ┌─────────────────────────────────────────────────────────┐   │  │  │
│  │  │  │  Dropout (0.3)                                          │   │  │  │
│  │  │  │  Linear (768 → 256)                                     │   │  │  │
│  │  │  │  ReLU                                                   │   │  │  │
│  │  │  │  Dropout (0.3)                                          │   │  │  │
│  │  │  │  Linear (256 → 2)                                       │   │  │  │
│  │  │  │  Softmax                                                │   │  │  │
│  │  │  └─────────────────────────────────────────────────────────┘   │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  训练配置:                                                                   │
│  ├── 优化器: AdamW (lr=2e-5, weight_decay=0.01)                             │
│  ├── 损失函数: CrossEntropyLoss                                             │
│  ├── 批大小: 16                                                              │
│  ├── 最大序列长度: 512                                                       │
│  └── 训练轮数: 3-5 epochs                                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
                    输出: 钓鱼概率 (0.0 - 1.0)
```

### 视觉相似度检测详解
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         视觉相似度检测架构                                   │
└─────────────────────────────────────────────────────────────────────────────┘

                              输入: URL
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Playwright截图模块                                      │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  1. 启动无头Chromium浏览器                                             │  │
│  │  2. 导航到目标URL                                                      │  │
│  │  3. 等待页面加载完成 (networkidle)                                     │  │
│  │  4. 截取全屏截图 (1280×720)                                            │  │
│  │  5. 保存为PNG格式                                                      │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      MobileNetV2特征提取                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  模型架构:                                                             │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  输入: 截图 (224×224×3)                                         │  │  │
│  │  │           │                                                     │  │  │
│  │  │           ▼                                                     │  │  │
│  │  │  MobileNetV2 (ImageNet预训练)                                   │  │  │
│  │  │  ├── Conv2D (3→32, stride=2)                                   │  │  │
│  │  │  ├── InvertedResidual × 17                                     │  │  │
│  │  │  │   ├── Expansion (1×1 Conv)                                  │  │  │
│  │  │  │   ├── Depthwise (3×3 Conv)                                  │  │  │
│  │  │  │   └── Projection (1×1 Conv)                                 │  │  │
│  │  │  ├── Conv2D (320→1280)                                         │  │  │
│  │  │  └── GlobalAveragePooling                                      │  │  │
│  │  │           │                                                     │  │  │
│  │  │           ▼                                                     │  │  │
│  │  │  输出: 特征向量 (1280维)                                        │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      FAISS向量检索                                           │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  索引类型: IndexFlatIP (内积相似度)                                    │  │
│  │                                                                        │  │
│  │  已知网站数据库:                                                       │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │  网站名称          │  特征向量 (1280维)                         │  │  │
│  │  ├───────────────────┼─────────────────────────────────────────────┤  │  │
│  │  │  google.com       │  [0.12, 0.34, ..., 0.56]                   │  │  │
│  │  │  paypal.com       │  [0.23, 0.45, ..., 0.67]                   │  │  │
│  │  │  amazon.com       │  [0.34, 0.56, ..., 0.78]                   │  │  │
│  │  │  facebook.com     │  [0.45, 0.67, ..., 0.89]                   │  │  │
│  │  │  microsoft.com    │  [0.56, 0.78, ..., 0.90]                   │  │  │
│  │  │  ...              │  ...                                       │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  │                                                                        │  │
│  │  检索流程:                                                             │  │
│  │  1. 输入特征向量归一化                                                 │  │
│  │  2. 计算与所有已知网站的余弦相似度                                     │  │
│  │  3. 返回Top-K最相似结果                                                │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  输出结果:                                                                   │
│  {                                                                           │
│    "similarity_score": 0.92,                                                │
│    "most_similar_site": "paypal.com",                                       │
│    "is_potential_phishing": true,                                           │
│    "top_matches": [                                                          │
│      {"site": "paypal.com", "score": 0.92},                                 │
│      {"site": "paypal-login.com", "score": 0.85},                           │
│      {"site": "ebay.com", "score": 0.45}                                    │
│    ]                                                                         │
│  }                                                                           │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## API端点参考

### 主要端点列表
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              API端点参考                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  基础端点 (app.py):                                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  GET  /              - 首页                                           │  │
│  │  GET  /predict       - 预测页面                                       │  │
│  │  GET  /training      - 训练控制台                                     │  │
│  │  GET  /evaluation    - 评估报告                                       │  │
│  │  GET  /explanation   - 模型解释                                       │  │
│  │  GET  /pipeline      - 管道浏览器                                     │  │
│  │  GET  /tutorial      - 使用教程                                       │  │
│  │  POST /predict_live  - 实时预测 (30特征输入)                          │  │
│  │  POST /train         - 启动训练                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  企业级API (networksecurity/api/app.py):                                     │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │  GET  /api/v1/health           - 健康检查                             │  │
│  │  GET  /api/v1/metrics          - Prometheus指标                       │  │
│  │  POST /api/v1/predict          - 批量预测                             │  │
│  │  POST /api/v1/predict/url      - URL端到端预测                        │  │
│  │  POST /api/v1/explain          - SHAP模型解释                         │  │
│  │  POST /api/v1/detect/advanced  - 高级集成检测 (待实现)                │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              依赖关系图                                      │
└─────────────────────────────────────────────────────────────────────────────┘

核心依赖:
├── Python 3.8+
├── FastAPI + Uvicorn (Web框架)
├── scikit-learn (机器学习)
├── XGBoost (梯度提升)
├── TensorFlow/Keras (深度学习)
├── pandas + numpy (数据处理)
└── pymongo (数据库)

高级检测依赖:
├── transformers + torch (BERT)
├── playwright (网页截图)
├── faiss-cpu (向量检索)
├── Pillow (图像处理)
└── beautifulsoup4 (HTML解析)

URL特征提取依赖:
├── python-whois (WHOIS查询)
├── dnspython (DNS查询)
├── requests (HTTP请求)
└── ssl (证书验证)

模型解释依赖:
└── shap (SHAP值计算)

监控依赖:
└── prometheus_client (指标收集)
```

---

## 快速启动

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 安装Playwright浏览器 (可选，用于视觉检测)
playwright install chromium

# 3. 启动服务
python app.py

# 4. 访问Web界面
# http://localhost:8000

# 5. 运行测试
pytest tests/ -v
```

---

## 版本信息

- **版本**: 2.0.0
- **更新日期**: 2024-12
- **作者**: Network Security Team
- **许可证**: MIT
