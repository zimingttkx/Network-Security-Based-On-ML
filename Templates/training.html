<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="train.title">模型训练</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/main.css" rel="stylesheet">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-shield-alt"></i>
                <span data-i18n="nav.home">网络安全检测</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-home"></i>
                            <span data-i18n="nav.home">首页</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/predict">
                            <i class="fas fa-chart-line"></i>
                            <span data-i18n="nav.predict">威胁预测</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/train">
                            <i class="fas fa-brain"></i>
                            <span data-i18n="nav.train">模型训练</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/tutorial">
                            <i class="fas fa-book-open"></i>
                            <span data-i18n="nav.tutorial">使用教程</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/docs" target="_blank">
                            <i class="fas fa-code"></i>
                            <span data-i18n="nav.api">API文档</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <select id="languageSelector" class="language-selector" onchange="setLanguage(this.value)">
                            <option value="zh-CN">中文</option>
                            <option value="en-US">English</option>
                            <option value="ja-JP">日本語</option>
                        </select>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <section class="py-5" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: calc(100vh - 200px);">
        <div class="container">
            <div class="text-center text-white mb-5">
                <h1 class="display-4 fw-bold">
                    <i class="fas fa-cogs"></i>
                    <span data-i18n="train.title">模型训练</span>
                </h1>
                <p class="lead" data-i18n="train.desc">训练新的机器学习模型以提高检测准确率</p>
            </div>

            <div class="row">
                <!-- 训练控制面板 -->
                <div class="col-lg-4 mb-4">
                    <!-- 数据源选择 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="mb-0">
                                <i class="fas fa-database"></i>
                                数据源选择
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">选择训练数据</label>
                                <select id="dataSource" class="form-select">
                                    <option value="default">使用项目默认数据</option>
                                    <option value="custom">上传自定义数据</option>
                                </select>
                            </div>

                            <!-- 自定义数据上传区 -->
                            <div id="customDataSection" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">上传CSV文件</label>
                                    <input type="file" class="form-control" id="dataFile" accept=".csv">
                                    <small class="text-muted">支持CSV格式，最大10MB</small>
                                </div>
                                <button id="validateBtn" class="btn btn-outline-primary w-100 mb-2">
                                    <i class="fas fa-check-circle"></i> 验证数据
                                </button>
                                <button id="viewRequirementsBtn" class="btn btn-outline-info w-100">
                                    <i class="fas fa-info-circle"></i> 查看特征要求
                                </button>
                            </div>

                            <!-- 验证结果 -->
                            <div id="validationResult" style="display: none;" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- 训练控制 -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">
                                <i class="fas fa-play-circle"></i>
                                <span data-i18n="train.status">训练控制</span>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                <strong>提示：</strong>点击按钮启动模型训练流程。训练将自动执行数据摄取、验证、转换和模型优化。
                            </div>
                            <button id="train-btn" class="btn btn-primary btn-lg w-100 mb-3">
                                <i class="fas fa-rocket"></i>
                                <span data-i18n="train.start">开始训练</span>
                            </button>
                            <div id="statusBadge" class="text-center">
                                <span class="badge badge-custom bg-secondary">
                                    <i class="fas fa-circle"></i> 等待启动
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- 性能指标 -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h3 class="mb-0">
                                <i class="fas fa-chart-bar"></i>
                                <span data-i18n="train.metrics">性能指标</span>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span data-i18n="train.accuracy">准确率</span>
                                    <strong id="accuracyValue">--</strong>
                                </div>
                                <div class="progress">
                                    <div id="accuracyBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span data-i18n="train.precision">精确率</span>
                                    <strong id="precisionValue">--</strong>
                                </div>
                                <div class="progress">
                                    <div id="precisionBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span data-i18n="train.recall">召回率</span>
                                    <strong id="recallValue">--</strong>
                                </div>
                                <div class="progress">
                                    <div id="recallBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-0">
                                <div class="d-flex justify-content-between mb-1">
                                    <span data-i18n="train.f1">F1分数</span>
                                    <strong id="f1Value">--</strong>
                                </div>
                                <div class="progress">
                                    <div id="f1Bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 训练日志 -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="mb-0">
                                <i class="fas fa-terminal"></i>
                                <span data-i18n="train.logs">实时训练日志</span>
                            </h3>
                        </div>
                        <div class="card-body p-0">
                            <!-- 进度指示器 -->
                            <div class="p-3 bg-light border-bottom">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold" data-i18n="train.progress">训练进度</span>
                                    <span id="progress-text" class="badge bg-info">等待启动...</span>
                                </div>
                                <div class="progress" style="height: 20px;">
                                    <div id="overall-progress" class="progress-bar progress-bar-striped progress-bar-animated"
                                         role="progressbar" style="width: 0%">0%</div>
                                </div>
                            </div>

                            <!-- 日志终端 -->
                            <div id="terminal" class="log-terminal" style="height: 500px; max-height: 500px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-4 bg-dark text-white text-center">
        <div class="container">
            <p class="mb-0">&copy; 2025 网络安全威胁检测系统. All rights reserved.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/i18n.js"></script>
    <script>
        let socket = null;

        // 动态获取WebSocket URL，支持任何域名和端口
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const WS_URL = `${protocol}//${window.location.host}/ws/train`;

        // 数据源选择处理
        document.getElementById('dataSource').addEventListener('change', function() {
            const customSection = document.getElementById('customDataSection');
            customSection.style.display = this.value === 'custom' ? 'block' : 'none';
        });

        // 查看特征要求
        document.getElementById('viewRequirementsBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/features/requirements');
                const data = await response.json();

                let html = '<div class="alert alert-info"><h5>需要的30个特征：</h5><ol class="small">';
                data.features.forEach((f, i) => {
                    html += `<li><strong>${f.name}</strong>: ${f.description}</li>`;
                });
                html += '</ol></div>';

                document.getElementById('validationResult').innerHTML = html;
                document.getElementById('validationResult').style.display = 'block';
            } catch (e) {
                alert('获取特征要求失败: ' + e.message);
            }
        });

        // 验证数据
        document.getElementById('validateBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('dataFile');
            if (!fileInput.files.length) {
                alert('请先选择文件');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/api/data/validate', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    let html = '<div class="' + (result.is_valid ? 'alert-success' : 'alert-warning') + ' alert">';
                    html += `<h5>验证结果 - ${result.filename}</h5>`;
                    html += `<p><strong>数据量:</strong> ${result.rows}行 x ${result.columns}列</p>`;

                    if (result.is_valid) {
                        html += '<p class="text-success"><i class="fas fa-check-circle"></i> 数据验证通过！可以直接用于训练。</p>';
                    } else {
                        const report = result.validation_report;
                        html += '<p class="text-warning"><i class="fas fa-exclamation-triangle"></i> 数据存在问题：</p><ul>';

                        if (report.missing_features && report.missing_features.length > 0) {
                            html += `<li>缺少特征: ${report.missing_features.join(', ')}</li>`;
                        }

                        if (Object.keys(report.missing_values).length > 0) {
                            html += '<li>存在缺失值的特征:<ul>';
                            for (const [col, info] of Object.entries(report.missing_values)) {
                                html += `<li>${col}: ${info.count}个 (${info.percentage}%)</li>`;
                            }
                            html += '</ul></li>';
                        }

                        html += '</ul><h6>建议的解决方案:</h6><ul>';
                        report.recommendations.forEach(rec => {
                            html += `<li><strong>${rec.issue}</strong>: ${rec.solution}</li>`;
                        });
                        html += '</ul>';

                        // 补全建议
                        const impSugg = result.imputation_suggestions;
                        html += `<div class="mt-3"><h6>推荐的补全策略:</h6>`;
                        html += `<p>数据缺失率: ${impSugg.missing_percentage}%</p>`;
                        html += '<select class="form-select mb-2" id="imputeStrategy">';
                        impSugg.suggestions.forEach(s => {
                            html += `<option value="${s.strategy}">${s.reason} (${s.strategy})</option>`;
                        });
                        html += '</select>';
                        html += '<button class="btn btn-primary btn-sm" onclick="imputeData()">执行数据补全</button>';
                        html += '</div>';
                    }

                    html += '</div>';
                    document.getElementById('validationResult').innerHTML = html;
                    document.getElementById('validationResult').style.display = 'block';
                } else {
                    alert('验证失败: ' + result.message);
                }
            } catch (e) {
                alert('验证过程出错: ' + e.message);
            }
        });

        // 执行数据补全
        async function imputeData() {
            const fileInput = document.getElementById('dataFile');
            const strategy = document.getElementById('imputeStrategy').value;

            if (!fileInput.files.length) {
                alert('请先选择文件');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('strategy', strategy);
            formData.append('fill_value', '0');

            try {
                const response = await fetch('/api/data/impute', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.status === 'success') {
                    let html = '<div class="alert alert-success">';
                    html += '<h5><i class="fas fa-check-circle"></i> 数据补全成功！</h5>';
                    html += `<p>${result.message}</p>`;
                    html += `<p><strong>补全后数据:</strong> ${result.rows}行 x ${result.columns}列</p>`;
                    html += '<h6>补全详情:</h6><ul>';
                    if (result.impute_report.added_features.length > 0) {
                        html += `<li>新增特征: ${result.impute_report.added_features.join(', ')}</li>`;
                    }
                    if (Object.keys(result.impute_report.imputed_values).length > 0) {
                        html += '<li>补全的特征:<ul>';
                        for (const [col, info] of Object.entries(result.impute_report.imputed_values)) {
                            html += `<li>${col}: ${info.missing_count}个缺失值使用${info.strategy}策略补全</li>`;
                        }
                        html += '</ul></li>';
                    }
                    html += '</ul>';
                    html += `<a href="/api/data/download/${result.output_file.split('/')[1]}" class="btn btn-success mt-2">`;
                    html += '<i class="fas fa-download"></i> 下载补全后的数据</a>';
                    html += '</div>';

                    document.getElementById('validationResult').innerHTML = html;
                } else {
                    alert('补全失败: ' + result.message);
                }
            } catch (e) {
                alert('补全过程出错: ' + e.message);
            }
        }

        // 添加日志
        function addLog(message, type = '') {
            const terminal = document.getElementById('terminal');
            const line = document.createElement('div');
            line.className = `log-line ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        }

        // 更新进度条
        function updateProgressBar(progressStr) {
            const [current, total] = progressStr.split('/').map(Number);
            const percentage = total > 0 ? ((current / total) * 100).toFixed(2) : 0;

            const progressBar = document.getElementById('overall-progress');
            const progressText = document.getElementById('progress-text');

            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
            progressText.textContent = `${current}/${total} 已完成`;
        }

        // 更新状态徽章
        function updateStatus(status, type = 'secondary') {
            const statusBadge = document.getElementById('statusBadge');
            const iconMap = {
                'waiting': 'circle',
                'running': 'spinner fa-spin',
                'success': 'check-circle',
                'error': 'exclamation-circle'
            };
            const icon = iconMap[type] || 'circle';
            statusBadge.innerHTML = `
                <span class="badge badge-custom bg-${type === 'waiting' ? 'secondary' : type === 'running' ? 'primary' : type === 'success' ? 'success' : 'danger'}">
                    <i class="fas fa-${icon}"></i> ${status}
                </span>
            `;
        }

        // 更新性能指标
        function updateMetrics(metrics) {
            const metricsMap = {
                'accuracy': { value: 'accuracyValue', bar: 'accuracyBar' },
                'precision': { value: 'precisionValue', bar: 'precisionBar' },
                'recall': { value: 'recallValue', bar: 'recallBar' },
                'f1': { value: 'f1Value', bar: 'f1Bar' }
            };

            Object.keys(metrics).forEach(key => {
                if (metricsMap[key]) {
                    const percentage = (metrics[key] * 100).toFixed(2);
                    document.getElementById(metricsMap[key].value).textContent = percentage + '%';
                    document.getElementById(metricsMap[key].bar).style.width = percentage + '%';
                }
            });
        }

        // 训练按钮点击事件
        document.getElementById('train-btn').addEventListener('click', async () => {
            const trainBtn = document.getElementById('train-btn');
            const terminal = document.getElementById('terminal');

            // 清空日志
            terminal.innerHTML = '';

            // 重置指标
            ['accuracyValue', 'precisionValue', 'recallValue', 'f1Value'].forEach(id => {
                document.getElementById(id).textContent = '--';
            });
            ['accuracyBar', 'precisionBar', 'recallBar', 'f1Bar'].forEach(id => {
                document.getElementById(id).style.width = '0%';
            });

            // 禁用按钮
            trainBtn.disabled = true;
            trainBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>训练中...';
            updateStatus('训练中', 'running');

            // 建立WebSocket连接
            socket = new WebSocket(WS_URL);

            socket.onopen = () => {
                addLog('>> WebSocket连接已建立，等待训练数据...', 'success');
            };

            socket.onclose = () => {
                addLog('>> WebSocket连接已关闭', 'warning');
                trainBtn.disabled = false;
                trainBtn.innerHTML = '<i class="fas fa-rocket"></i> 开始训练';
                updateStatus('已停止', 'waiting');
            };

            socket.onerror = () => {
                addLog('>> WebSocket连接错误', 'error');
                updateStatus('连接错误', 'error');
            };

            socket.onmessage = (event) => {
                const message = event.data;

                if (message.startsWith('[PROGRESS]')) {
                    updateProgressBar(message.replace('[PROGRESS]', ''));
                } else if (message.includes('[ERROR]') || message.includes('错误') || message.includes('失败')) {
                    addLog(message, 'error');
                    updateStatus('训练失败', 'error');
                } else if (message.includes('[FINISH]') || message.includes('完成')) {
                    addLog(message, 'success');
                    updateStatus('训练完成', 'success');

                    // 模拟性能指标（实际应从服务器获取）
                    setTimeout(() => {
                        updateMetrics({
                            accuracy: 0.95 + Math.random() * 0.04,
                            precision: 0.93 + Math.random() * 0.05,
                            recall: 0.92 + Math.random() * 0.06,
                            f1: 0.94 + Math.random() * 0.04
                        });
                    }, 500);
                } else if (message.includes('开始') || message.includes('Starting')) {
                    addLog(message, 'info');
                } else {
                    addLog(message);
                }
            };

            // 触发训练
            try {
                const response = await fetch('/api/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || '服务器触发失败');
                }
                const result = await response.json();
                addLog(`>> ${result.message}`, 'success');
            } catch (e) {
                addLog(`>> 触发失败: ${e.message}`, 'error');
                updateStatus('启动失败', 'error');
                if (socket) socket.close();
            }
        });
    </script>
</body>
</html>
